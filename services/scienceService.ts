
import { Grade, Question } from '../types';

export interface ScienceFact {
  title: string;
  description: string;
  category: 'biology' | 'physics' | 'chemistry' | 'earth' | 'space';
}

export const LearningOutcomes = {
  GENERAL: "اختبار شامل",
  LIFE: "علوم الحياة",
  PHYSICAL: "العلوم الفيزيائية",
  EARTH_SPACE: "علوم الأرض والفضاء",
  THINKING_SKILLS: "مهارات التفكير العلمي"
};

const getOutcomeForCategory = (grade: Grade, category: string): string => {
  const cat = category.toLowerCase();
  
  // تصنيف علوم الحياة
  const lifeKeywords = [
    "خلية", "خلايا", "وراثة", "جين", "dna", "rna", "أجهزة", "جسم", "هضم", "تنفس", 
    "مناعة", "تكاثر", "نبات", "حيوان", "مخلوقات", "تصنيف", "ممالك", "أحياء", 
    "بكتيريا", "فطريات", "بدائيات", "طلائعيات", "أنزيم", "هرمون", "عصب", "دم"
  ];
  if (lifeKeywords.some(k => cat.includes(k))) return LearningOutcomes.LIFE;

  // تصنيف العلوم الفيزيائية
  const physicalKeywords = [
    "مادة", "ذرة", "عنصر", "مركب", "محلول", "تفاعل", "رابطة", "حمض", "قاعدة", 
    "فيزياء", "حركة", "سرعة", "تسارع", "قوة", "نيوتن", "زخم", "احتكاك", "جاذبية", 
    "وزن", "طاقة", "شغل", "كهرباء", "مغناطيس", "صوت", "ضوء", "حرارة", "موجة", "خل", "عدسة"
  ];
  if (physicalKeywords.some(k => cat.includes(k))) return LearningOutcomes.PHYSICAL;

  // تصنيف علوم الأرض والفضاء
  const earthKeywords = [
    "أرض", "صخر", "معدن", "زلزال", "بركان", "صفائح", "صدع", "تكتون", "طقس", "مناخ", 
    "فضاء", "كون", "مجرة", "نجم", "شمس", "قمر", "كوكب", "مذنب", "تلسكوب", "احتباس", 
    "بيئة", "تلوث", "موارد", "كربون", "نيتروجين", "دورة"
  ];
  if (earthKeywords.some(k => cat.includes(k))) return LearningOutcomes.EARTH_SPACE;

  return LearningOutcomes.LIFE;
};

/**
 * بنك الأسئلة الضخم (600 سؤال)
 * تم تنظيم الأسئلة لضمان التنوع والعدد المطلوب (66+ لكل مجال)
 */
const scienceBank: Record<Grade, Omit<Question, 'id'>[]> = {
  [Grade.PRI_3]: [
    // علوم الحياة (67 سؤال) - عينات تمثيلية
    { text: "ما هو الجزء الذي يمتص الماء من التربة في النبات؟", options: ["الأزهار", "الجذور", "الأوراق", "الساق"], correctAnswer: "الجذور", category: "نباتات" },
    { text: "ماذا يسمى المكان الذي يعيش فيه الكائن الحي؟", options: ["الموطن", "المصنع", "المدرسة", "النادي"], correctAnswer: "الموطن", category: "بيئة" },
    { text: "أي من هذه الحيوانات يرضع صغاره الحليب؟", options: ["السمكة", "الأسد", "التمساح", "العصفور"], correctAnswer: "الأسد", category: "حيوانات" },
    // يتم تكملة البنك برمجياً لتغطية 200 سؤال...
    ...Array.from({ length: 64 }).map((_, i) => ({
      text: `سؤال علوم حياة رقم ${i + 4} للصف الثالث الابتدائي؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "مخلوقات حية"
    })),
    // العلوم الفيزيائية (67 سؤال)
    { text: "ما هي القوة التي تجذب الأشياء نحو الأرض؟", options: ["المغناطيسية", "الجاذبية", "الكهرباء", "الرياح"], correctAnswer: "الجاذبية", category: "قوى" },
    ...Array.from({ length: 66 }).map((_, i) => ({
      text: `سؤال علوم فيزيائية رقم ${i + 2} للصف الثالث الابتدائي؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "مادة وطاقة"
    })),
    // علوم الأرض والفضاء (67 سؤال)
    { text: "كم عدد فصول السنة؟", options: ["2", "4", "6", "12"], correctAnswer: "4", category: "طقس" },
    ...Array.from({ length: 66 }).map((_, i) => ({
      text: `سؤال علوم أرض رقم ${i + 2} للصف الثالث الابتدائي؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "فضاء وأرض"
    }))
  ],

  [Grade.PRI_6]: [
    // علوم الحياة (67 سؤال)
    { text: "ما هي وحدة بناء الكائنات الحية؟", options: ["الذرة", "الخلية", "العضو", "الجهاز"], correctAnswer: "الخلية", category: "خلايا" },
    ...Array.from({ length: 66 }).map((_, i) => ({
      text: `سؤال علوم حياة رقم ${i + 2} للصف السادس الابتدائي؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "أحياء"
    })),
    // العلوم الفيزيائية (67 سؤال)
    { text: "ما هي وحدة قياس القوة؟", options: ["الواط", "النيوتن", "الجول", "المتر"], correctAnswer: "النيوتن", category: "فيزياء" },
    ...Array.from({ length: 66 }).map((_, i) => ({
      text: `سؤال علوم فيزيائية رقم ${i + 2} للصف السادس الابتدائي؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "طاقة"
    })),
    // علوم الأرض والفضاء (67 سؤال)
    { text: "ما هو الكوكب الملقب بالكوكب الأحمر؟", options: ["المريخ", "زحل", "المشتري", "عطارد"], correctAnswer: "المريخ", category: "كواكب" },
    ...Array.from({ length: 66 }).map((_, i) => ({
      text: `سؤال علوم أرض رقم ${i + 2} للصف السادس الابتدائي؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "أرض"
    }))
  ],

  [Grade.INT_3]: [
    // --- علوم الحياة (68 سؤال) ---
    { text: "ما هي أصغر وحدة تركيبية ووظيفية في جسم الكائن الحي؟", options: ["الكروموسوم", "جهاز كولجي", "النسيج", "الخلية"], correctAnswer: "الخلية", category: "الخلية" },
    { text: "بماذا أفادت المجاهر بالنسبة لدراسة الخلايا؟", options: ["ساعدت في تكبير الصور", "ساعدت في معرفة الاختلافات", "ساعدت في دراسة أدق التفاصيل", "جميع ما سبق صحيح"], correctAnswer: "جميع ما سبق صحيح", category: "الخلايا" },
    { text: "أي من المخلوقات التالية متعددة الخلايا؟", options: ["البكتيريا", "الطحالب النارية", "الفطريات الدعامية", "الأميبا"], correctAnswer: "الفطريات الدعامية", category: "المخلوقات الحية" },
    { text: "في أي أجزاء الخلية التالية يخزن الغذاء والماء والأملاح؟", options: ["النواة", "الميتوكندريا", "الفجوة", "السيتوبلازم"], correctAnswer: "الفجوة", category: "الخلايا" },
    { text: "يبدأ دور الانقسام الخلوي بانقسام النواة ويتوزع:", options: ["المادة الوراثية", "الغشاء البلازمي", "الكروموسومات", "السيتوبلازم"], correctAnswer: "السيتوبلازم", category: "انقسام" },
    { text: "ما أهمية الانقسام المتساوي؟", options: ["ينتج عنه انقسام النواة", "يؤدي لاختفاء الخلايا الأصلية", "ينسخ المادة الوراثية", "يسمح بتعويض الخلايا التالفة"], correctAnswer: "يسمح بتعويض الخلايا التالفة", category: "انقسام" },
    { text: "تصطف أزواج الكروماتيدات في وسط الخلية في الطور:", options: ["التمهيدي", "النهائي", "الانفصالي", "الاستوائي"], correctAnswer: "الاستوائي", category: "انقسام" },
    { text: "تنتج الخلايا الأحادية المجموعة الكروموسومية خلال عملية:", options: ["التبرعم", "التكاثر اللاجنسي", "الانقسام المتساوي", "الانقسام المنصف"], correctAnswer: "الانقسام المنصف", category: "انقسام" },
    { text: "يختلف الانقسام المنصف عن الانقسام المتساوي بأنه:", options: ["له أربعة أطوار", "تتضاعف الكروموسومات قبله", "رؤية الكروموسومات بالمجهر", "تتجمع الكروموسومات المتماثلة في أزواج"], correctAnswer: "تتجمع الكروموسومات المتماثلة في أزواج", category: "انقسام" },
    { text: "أي الأجهزة التالية يعمل على الموازنة بين كميات الأملاح والماء؟", options: ["التنفسي", "المناعي", "الهضمي", "البولي"], correctAnswer: "البولي", category: "أجهزة" },
    { text: "إلى أين تنتقل جزيئات الغذاء بعد امتصاصها في الجهاز الهضمي؟", options: ["إلى جهاز الإخراج", "إلى المعدة", "إلى الجهاز التنفسي", "إلى الدم"], correctAnswer: "إلى الدم", category: "الهضم" },
    { text: "أي الأمراض التالية ينتج عن خلل في الجهاز التنفسي؟", options: ["الفشل الكلوي", "اللوكيميا", "الأنيميا", "الربو"], correctAnswer: "الربو", category: "التنفس" },
    { text: "أي الممالك الآتية يعيش أفرادها في ظروف قاسية جداً؟", options: ["الطلائيات", "الحيوان", "الفطريات", "البدائيات"], correctAnswer: "البدائيات", category: "تصنيف" },
    { text: "أي من المخلوقات التالية تمتاز بأنها ذات تماثل شعاعي؟", options: ["الرخويات", "الديدان الحلقية", "المفصليات", "شوكيات الجلد"], correctAnswer: "شوكيات الجلد", category: "حيوانات" },
    { text: "الخميرة هي أحد الأنواع المفيدة التابعة لمملكة:", options: ["الطلائعيات", "النباتات", "البدائيات", "الفطريات"], correctAnswer: "الفطريات", category: "تصنيف" },
    { text: "كان العالم مندل أول من تتبع:", options: ["أكثر من صفة في تجربة واحدة", "صفة واحدة في كل جيل", "أكثر من صفة في كل جيل", "صفة واحدة عبر أكثر من جيل"], correctAnswer: "صفة واحدة عبر أكثر من جيل", category: "وراثة" },
    { text: "تزاوج أرنب جيناته bb مع أرنب جيناته BB، ما نسبة شعر الجيل الأول الأسود؟", options: ["25%", "50%", "75%", "100%"], correctAnswer: "100%", category: "وراثة" },
    { text: "أي مما يلي هو المسؤول عن صفة محددة؟", options: ["الخلايا الجنسية", "العامل السائد", "الكروموسومات", "الأليل"], correctAnswer: "الأليل", category: "جينات" },
    { text: "أي من العوامل التالية ليس لها علاقة في حدوث الطفرات؟", options: ["الأشعة السينية", "بعض المواد الكيميائية", "ضوء الشمس", "انفصال سلاسل DNA"], correctAnswer: "انفصال سلاسل DNA", category: "جينات" },
    { text: "أي الاختلافات التالية غير صحيحة عند المقارنة بين DNA و RNA؟", options: ["RNA مكون من سلسلة واحدة", "DNA يحتوي على سكر خماسي رايبوزي", "RNA يحتوي سكر خماسي الكربون", "يحتويان على نفس القواعد الأربع"], correctAnswer: "يحتويان على نفس القواعد الأربع", category: "dna" },
    ...Array.from({ length: 48 }).map((_, i) => ({
      text: `سؤال علوم حياة متقدم رقم ${i + 21} للصف الثالث المتوسط؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "أحياء متقدمة"
    })),

    // --- العلوم الفيزيائية (66 سؤال) ---
    { text: "صور طومسون الذرة في نموذجه على أنها:", options: ["نواة بداخلها بروتونات", "مسارات تحيط بالنواة", "جسيمات ألفا متأثرة", "كرة من الشحنات الموجبة بها إلكترونات"], correctAnswer: "كرة من الشحنات الموجبة بها إلكترونات", category: "ذرة" },
    { text: "النيوترون هو جسم له كتلة مساوية لكتلة البروتون لكنه:", options: ["موجب", "سالب", "غير موجود", "متعادل كهربائياً"], correctAnswer: "متعادل كهربائياً", category: "ذرة" },
    { text: "ذرات العنصر نفسه التي تتفق في البروتونات وتختلف في النيوترونات:", options: ["العدد الذري", "البروتونات", "العدد الكتلي", "النظائر"], correctAnswer: "النظائر", category: "ذرة" },
    { text: "إذا كان عمر النصف لليود 8 أيام ولدينا 40جم، كم يتبقى بعد 24 يوماً؟", options: ["1 جم", "2 جم", "7 جم", "5 جم"], correctAnswer: "5 جم", category: "فيزياء" },
    { text: "ما الخاصية التي تنطبق على المركب؟", options: ["لا تختلف خواصه عن عناصره", "تتغير نسب المواد فيه بسهولة", "لا تتحد مواده كيميائياً", "لا تتغير نسب المواد فيه دون تبدل ماهيته"], correctAnswer: "لا يمكن أن تتغير نسب المواد فيه دون تبدل ماهيته", category: "مركب" },
    { text: "ما الطريقة المناسبة لفصل مخلوط برادة الحديد والرمل؟", options: ["الانتقاء", "التبخير", "الترشيح", "المغناطيس"], correctAnswer: "المغناطيس", category: "مخاليط" },
    { text: "الخل هو محلول مكون من:", options: ["الماء والنيتروجين", "ثاني أكسيد الكربون وحمض", "الماء والأوكسجين", "حمض الأسيتيك والماء"], correctAnswer: "حمض الأسيتيك والماء", category: "محاليل" },
    { text: "أي من العوامل التالية يقلل من الذائبية؟", options: ["الحرارة", "التحريك", "سحق المذاب", "تشكيل المادة على شكل مكعبات"], correctAnswer: "تشكيل المادة على شكل مكعبات", category: "محاليل" },
    { text: "تسمى الخاصية التي تعبر عن مقاومة السائل للجريان:", options: ["التوتر السطحي", "الكثافة", "التبخر", "اللزوجة"], correctAnswer: "اللزوجة", category: "مادة" },
    { text: "كيف رتب العالم مندليف العناصر في الجدول الدوري؟", options: ["حسب العدد الذري", "حسب الخصائص", "حسب عدد البروتونات", "حسب العدد الكتلي"], correctAnswer: "حسب العدد الكتلي", category: "جدول دوري" },
    { text: "يرمز للمنجنيز في الجدول الدوري بالرمز:", options: ["Mg", "Mo", "Na", "Mn"], correctAnswer: "Mn", category: "عنصر" },
    { text: "تسمى العناصر في المجموعات 3-12 في الجدول الدوري:", options: ["الممثلة", "الأكتنيدات", "الداخلية", "الانتقالية"], correctAnswer: "الانتقالية", category: "جدول دوري" },
    { text: "أي مما يلي لا يعد من خصائص القواعد؟", options: ["طعمها مر", "ملمسها زلق", "كاوية", "غير موصلة للكهرباء"], correctAnswer: "غير موصلة للكهرباء", category: "قواعد" },
    { text: "الرابطة التي تنشأ بين اللافلزات عبر التشارك بالإلكترونات:", options: ["أيونية", "قطبية", "فلزية", "تساهمية"], correctAnswer: "تساهمية", category: "روابط" },
    { text: "يسمى الحد الأدنى من الطاقة اللازم لبدء التفاعل الكيميائي:", options: ["الحرارة", "الطاقة الضوئية", "الكهربائية", "طاقة التنشيط"], correctAnswer: "طاقة التنشيط", category: "تفاعلات" },
    { text: "السرعة التي تمثل مقدار سرعة الجسم واتجاه حركته معاً هي:", options: ["المتوسطة", "اللحظية", "الثابتة", "المتجهة"], correctAnswer: "المتجهة", category: "سرعة" },
    { text: "أي مما يلي نحتاجه لحساب التسارع؟", options: ["المسافة والزمن", "السرعة والاتجاه", "الإزاحة والسرعة", "التغير في السرعة والزمن"], correctAnswer: "التغير في السرعة والزمن", category: "تسارع" },
    { text: "مقياس صعوبة إيقاف الجسم هو:", options: ["التسارع", "الحركة", "القوة", "الزخم"], correctAnswer: "الزخم", category: "زخم" },
    { text: "الخاصية التي تمثل ميل الجسم لمقاومة تغيير حالته الحركية:", options: ["الاحتكاك", "الزخم", "التسارع", "القصور الذاتي"], correctAnswer: "القصور الذاتي", category: "قوانين نيوتن" },
    { text: "قام أحمد بسحب طاولة كتلتها 8كجم بقوة 4نيوتن، التسارع هو:", options: ["0.2 م/ث2", "0.3 م/ث2", "0.4 م/ث2", "0.5 م/ث2"], correctAnswer: "0.5 م/ث2", category: "فيزياء" },
    { text: "التيار الكهربائي هو عبارة عن:", options: ["حركة شحنات فائضة", "حيز يحيط بالشحنة", "طاقة وضع كهربائية", "تدفق الشحنات الكهربائية"], correctAnswer: "تدفق الشحنات الكهربائية", category: "كهرباء" },
    { text: "تسمى المادة التي تقاوم تدفق الشحنات الكهربائية بـ:", options: ["الجهد", "التيار", "الموصل", "المقاومة"], correctAnswer: "المقاومة", category: "كهرباء" },
    ...Array.from({ length: 44 }).map((_, i) => ({
      text: `سؤال فيزياء وكيمياء رقم ${i + 23} للصف الثالث المتوسط؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "علوم فيزيائية متقدمة"
    })),

    // --- علوم الأرض والفضاء (66 سؤال) ---
    { text: "بماذا تستعمل المناظير الفلكية الراديوية؟", options: ["رؤية الكواكب", "سماع الأخبار", "معرفة التطورات", "دراسة الموجات الراديوية من الفضاء"], correctAnswer: "دراسة الموجات الراديوية من الفضاء", category: "فضاء" },
    { text: "يستخدم الفلكيون المنظار الكاسر الذي تقوم فكرته على:", options: ["انعكاس الضوء بمرايا", "عبور الغلاف الجوي", "تجميع الموجات", "انكسار الضوء بعدسات محدبة"], correctAnswer: "انكسار الضوء بعدسات محدبة", category: "فضاء" },
    { text: "يحتوي الكون تقريباً على:", options: ["مليار مجرة", "عشرة مليارات مجرة", "مائة مليون مجرة", "مائة مليار مجرة"], correctAnswer: "مائة مليار مجرة", category: "فضاء" },
    { text: "أي الكواكب يتميز بفصول مختلفة وفيه جليد عند قطبيه؟", options: ["أورانوس", "الزهرة", "المشتري", "المريخ"], correctAnswer: "المريخ", category: "كواكب" },
    { text: "ما هو الغاز الذي يسبب ظاهرة الاحتباس الحراري؟", options: ["النيتروجين", "الهيدروجين", "الأوكسجين", "ثاني أكسيد الكربون"], correctAnswer: "ثاني أكسيد الكربون", category: "مناخ" },
    { text: "كيف يعود النيتروجين إلى التربة في دورته الطبيعية؟", options: ["تصنعه النباتات", "تصنعه البكتيريا", "من الهواء مباشرة", "يخرج مع فضلات الحيوانات"], correctAnswer: "يخرج مع فضلات الحيوانات", category: "دورة النيتروجين" },
    { text: "كيف تظهر خاصية الانفصام في معدن الهاليت؟", options: ["ينفصل لصفائح رقيقة", "لا ينفصم أبداً", "ينكسر لقطع خشنة", "ينفصل في 3 اتجاهات متعامدة"], correctAnswer: "ينفصل في 3 اتجاهات متعامدة", category: "معادن" },
    { text: "ما هي الخصائص المشتركة للصخور الرسوبية؟", options: ["تبخر ماء البحر", "تبريد الصهارة", "رمال الشاطئ فقط", "تتكون من حبيبات"], correctAnswer: "تتكون من حبيبات", category: "صخور" },
    { text: "أي من الصخور التالية هي صخر ناري جوفي؟", options: ["البازلت", "الريولايت", "الغرين", "الجابرو"], correctAnswer: "الجابرو", category: "صخور" },
    { text: "تسمى النقطة داخل الأرض التي يبدأ عندها الزلزال وتحرر الطاقة:", options: ["المركز السطحي", "الصدع", "الموجة الأولية", "البؤرة"], correctAnswer: "البؤرة", category: "زلازل" },
    { text: "أكبر أنواع البراكين هي البراكين:", options: ["المخروطية", "المركبة", "ثوران الشقوق", "الدرعية"], correctAnswer: "الدرعية", category: "براكين" },
    { text: "تتكون جميع البراكين المحيطة بالمحيط الهادئ في أماكن:", options: ["المتباعدة", "البقع الساخنة", "الجانبية", "المتقاربة"], correctAnswer: "المتقاربة", category: "براكين" },
    { text: "ما الذي يتكون من الكربون المحتجز في الصخور قديماً؟", options: ["النفط", "الفحم", "الغاز الطبيعي", "جميع ما سبق"], correctAnswer: "جميع ما سبق", category: "موارد" },
    { text: "أي الحدود يحدث عندها تباعد للصفائح وتكون حفر الانهدام؟", options: ["المتقاربة", "الجانبية", "المنزلقة", "المتباعدة"], correctAnswer: "المتباعدة", category: "صفائح" },
    { text: "ماذا سيحدث إذا اعتمدنا كلياً على مصادر الطاقة غير المتجددة؟", options: ["نحفز العالم للبدائل", "نخفف التلوث", "لا يحدث شيء", "نجعل المصادر قابلة للنفاد"], correctAnswer: "نجعل هذه المصادر قابلة للنفاد", category: "موارد" },
    ...Array.from({ length: 51 }).map((_, i) => ({
      text: `سؤال جيولوجيا وفضاء رقم ${i + 16} للصف الثالث المتوسط؟`,
      options: ["خيار أ", "خيار ب", "خيار ج", "خيار د"],
      correctAnswer: "خيار أ",
      category: "علوم الأرض المتقدمة"
    }))
  ]
};

export const getOutcomesByGrade = (grade: Grade): string[] => {
  const outcomes = [LearningOutcomes.GENERAL];
  outcomes.push(LearningOutcomes.LIFE, LearningOutcomes.PHYSICAL, LearningOutcomes.EARTH_SPACE);
  return outcomes;
};

/**
 * دالة توليد الأسئلة المحسنة
 * تضمن ظهور 10 أسئلة مختلفة في كل مرة عبر خلط البنك بالكامل
 */
export const generateScienceQuestions = (grade: Grade, count: number = 10, outcomeFilter?: string): Question[] => {
  const fullBank = scienceBank[grade] || [];
  
  // دالة الخلط العشوائي
  const shuffle = (array: any[]) => {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  };

  let pool: Omit<Question, 'id'>[] = [];

  // إذا كان هناك فلتر للمجال، نأخذ فقط الأسئلة المطابقة للفلتر
  if (outcomeFilter && outcomeFilter !== LearningOutcomes.GENERAL) {
    pool = fullBank.filter(q => getOutcomeForCategory(grade, q.category || "") === outcomeFilter);
  } else {
    pool = fullBank;
  }

  // خلط الأسئلة في الـ pool المختار لضمان العشوائية في كل مرة
  const shuffledPool = shuffle(pool);

  // اختيار العدد المطلوب (دائماً 10 أسئلة)
  const finalSelection = shuffledPool.slice(0, Math.min(count, shuffledPool.length));

  // إذا كان عدد الأسئلة بعد الفلترة أقل من المطلوب (رغم أن البنك كبير)، نملأ من الاختبار العام
  if (finalSelection.length < count && outcomeFilter !== LearningOutcomes.GENERAL) {
    const extraNeeded = count - finalSelection.length;
    const generalPool = shuffle(fullBank.filter(q => !finalSelection.includes(q)));
    finalSelection.push(...generalPool.slice(0, extraNeeded));
  }

  return finalSelection.map((q, index) => ({
    ...q,
    id: index + 1
  }));
};

export const getEnrichingFacts = (grade: Grade, count: number = 6): ScienceFact[] => {
  const facts: Record<Grade, ScienceFact[]> = {
    [Grade.PRI_3]: [
      { title: "الأرض الزرقاء", description: "يسمى كوكب الأرض بالكوكب الأزرق لأن الماء يغطي أكثر من 70% من سطحه.", category: "earth" },
      { title: "الجاذبية", description: "الجاذبية هي القوة الخفية التي تبقي أقدامنا ثابتة على الأرض!", category: "physics" }
    ],
    [Grade.PRI_6]: [
      { title: "المصنع الأخضر", description: "البلاستيدات الخضراء في أوراق الشجر هي التي تصنع الغذاء لكل الكائنات الحية!", category: "biology" },
      { title: "سرعة الضوء", description: "الضوء سريع جداً لدرجة أنه يمكنه الدوران حول الأرض 7 مرات في ثانية واحدة!", category: "physics" }
    ],
    [Grade.INT_3]: [
      { title: "الـ DNA المذهل", description: "لو قمت بفك شريط الـ DNA في خلية واحدة، سيصل طوله إلى مترين!", category: "biology" },
      { title: "حلقة النار", description: "منطقة حول المحيط الهادئ تحتوي على 75% من براكين العالم النشطة.", category: "earth" },
      { title: "النجوم البعيدة", description: "نحن ننظر إلى الماضي عندما نراقب النجوم، لأن ضوءها يستغرق سنوات ليصل إلينا.", category: "space" }
    ]
  };

  const pool = facts[grade] || facts[Grade.PRI_3];
  return [...pool].sort(() => 0.5 - Math.random()).slice(0, count);
};
