
import { Grade, Question } from '../types';

export interface ScienceFact {
  title: string;
  description: string;
  category: 'biology' | 'physics' | 'chemistry' | 'earth' | 'space';
}

export const LearningOutcomes = {
  GENERAL: "اختبار شامل",
  LIFE: "علوم الحياة",
  PHYSICAL: "العلوم الفيزيائية",
  EARTH_SPACE: "علوم الأرض والفضاء",
  THINKING_SKILLS: "مهارات التفكير العلمي"
};

const shuffleArray = <T>(array: T[]): T[] => {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
};

const getOutcomeForCategory = (grade: Grade, category: string): string => {
  const cat = category.toLowerCase();
  // تصنيف علوم الحياة
  if (["خلية", "وراثة", "جين", "dna", "أجهزة", "جسم", "دم", "هضم", "تنفس", "مناعة", "نبات", "حيوان", "أحياء", "انقسام", "تكاثر", "إخصاب", "غدد", "عين", "أذن"].some(k => cat.includes(k))) return LearningOutcomes.LIFE;
  // تصنيف العلوم الفيزيائية
  if (["مادة", "ذرة", "تفاعل", "محاليل", "قوة", "نيوتن", "طاقة", "كهرباء", "ضوء", "حرارة", "سرعة", "تسارع", "زخم", "عنصر", "رابطة", "صوت", "تردد", "موجات"].some(k => cat.includes(k))) return LearningOutcomes.PHYSICAL;
  // تصنيف علوم الأرض والفضاء
  if (["أرض", "صخر", "زلزال", "بركان", "فضاء", "كون", "كوكب", "مناخ", "بيئة", "صفائح", "نجوم", "مجرة", "تربة", "موارد", "أوزون", "احتباس"].some(k => cat.includes(k))) return LearningOutcomes.EARTH_SPACE;
  return LearningOutcomes.LIFE;
};

const scienceBank: Record<Grade, Omit<Question, 'id'>[]> = {
  [Grade.PRI_3]: [
    { text: "ما هو الجزء الذي يثبت النبات في التربة ويمتص الماء؟", options: ["الأوراق", "الأزهار", "الساق", "الجذور"], correctAnswer: "الجذور", category: "نبات" },
    { text: "تسمى عملية صنع الغذاء في النبات بـ:", options: ["التنفس", "الهضم", "البناء الضوئي", "التكاثر"], correctAnswer: "البناء الضوئي", category: "نبات" },
    { text: "أي من الحيوانات التالية يمتلك عموداً فقرياً؟", options: ["الحشرة", "الأخطبوط", "الجمل", "الدودة"], correctAnswer: "الجمل", category: "حيوان" },
    { text: "ما هو الموطن الذي يتميز بالبرودة الشديدة والجليد؟", options: ["الصحراء", "المنطقة القطبية", "الغابة", "المراعي"], correctAnswer: "المنطقة القطبية", category: "بيئة" },
    ...Array.from({ length: 20 }).map((_, i) => ({
      text: `سؤال إضافي لثالث ابتدائي رقم ${i+5}؟`,
      options: ["خيار 1", "خيار 2", "خيار 3", "خيار 4"],
      correctAnswer: "خيار 1",
      category: "علوم عامة"
    }))
  ],

  [Grade.PRI_6]: [
    { text: "ما هو التركيب الذي يوجد في الخلية النباتية ولا يوجد في الخلية الحيوانية؟", options: ["النواة", "الميتوكندريا", "الجدار الخلوي", "الغشاء البلازمي"], correctAnswer: "الجدار الخلوي", category: "خلايا" },
    { text: "تنتقل الصفات الوراثية من الآباء إلى الأبناء عبر:", options: ["الدم", "الجينات", "الغذاء", "الهواء"], correctAnswer: "الجينات", category: "وراثة" },
    ...Array.from({ length: 20 }).map((_, i) => ({
      text: `سؤال إضافي لسادس ابتدائي رقم ${i+3}؟`,
      options: ["خيار 1", "خيار 2", "خيار 3", "خيار 4"],
      correctAnswer: "خيار 1",
      category: "علوم عامة"
    }))
  ],

  [Grade.INT_3]: [
    // --- علوم الحياة (أسئلة مرسلة + بنك) ---
    { text: "ما الذي يتكون في الدم لمحاربة مولدات الضد؟", options: ["الهرمونات", "المواد المسببة للحساسية", "مسببات المرض", "الأجسام المضادة"], correctAnswer: "الأجسام المضادة", category: "دم ومناعة" },
    { text: "أي الأمراض التالية سببه فيروس يهاجم خلايا الدم البيضاء؟", options: ["الإيدز", "الحصبة", "الإنفلونزا", "شلل الأطفال"], correctAnswer: "الإيدز", category: "أجهزة الجسم" },
    { text: "أي المواد الغذائية التالية تصنعها البكتيريا في الأمعاء الغليظة؟", options: ["الدهون", "الفيتامينات", "الأملاح المعدنية", "البروتينات"], correctAnswer: "الفيتامينات", category: "جهاز هضمي" },
    { text: "إلى أي المجموعات الغذائية ينتمي اللبن والحليب؟", options: ["الأطعمة الغنية بالكالسيوم", "البروتينات", "الحبوب", "الفواكه"], correctAnswer: "الأطعمة الغنية بالكالسيوم", category: "تغذية" },
    { text: "أي مما يلي ينقبض عند الشهيق ويتحرك إلى أسفل؟", options: ["الشعبتان الهوائيتان", "الحويصلات الهوائية", "الحجاب الحاجز", "القصبة الهوائية"], correctAnswer: "الحجاب الحاجز", category: "جهاز تنفسي" },
    { text: "التراكيب التي تحدث بينها وبين الشعيرات الدموية عملية تبادل الغازات هي:", options: ["الحويصلات", "الشعبتان الهوائيتان", "القصبات", "الشعيبات"], correctAnswer: "الحويصلات", category: "جهاز تنفسي" },
    { text: "أي المواد التالية لا يتم إعادة امتصاصها بعد مرورها في الكلية؟", options: ["الأملاح", "الفضلات", "الماء", "السكر"], correctAnswer: "الفضلات", category: "جهاز بولي" },
    { text: "أي مما يلي يسبب أمراض جهاز الدوران؟", options: ["التدخين", "استخدام مادة الأسبست", "الجري", "التعرض للأشعة فوق البنفسجية"], correctAnswer: "التدخين", category: "جهاز دوران" },
    { text: "أي مما يلي يعد من وظائف الدم؟", options: ["إفراز الأملاح خارج الجسم", "إفراز اللعاب في الفم", "نقل المواد الغذائية إلى خلايا الجسم", "التخلص من اللمف المحيط بالخلايا"], correctAnswer: "نقل المواد الغذائية إلى خلايا الجسم", category: "دم" },
    { text: "أي مما يلي يسببه التدخين؟", options: ["سرطان الرئة", "السكري", "الإنفلونزا", "التهاب المثانة"], correctAnswer: "سرطان الرئة", category: "صحة" },
    { text: "أي من هذه الأمراض يعتبر مرضاً غير معدٍ؟", options: ["التيتانوس", "الإنفلونزا", "الملاريا", "السكري"], correctAnswer: "السكري", category: "مناعة" },
    { text: "أين تنتج خلايا الدم الحمراء؟", options: ["العظم الكثيف", "الغضروف", "السمحاق", "نخاع العظم"], correctAnswer: "نخاع العظم", category: "جهاز هيكلي" },
    { text: "ماذا يغلف أطراف العظم؟", options: ["الغضروف", "العضلات", "الأوتار", "السمحاق"], correctAnswer: "الغضروف", category: "جهاز هيكلي" },
    { text: "توجد المفاصل غير المتحركة في الإنسان في:", options: ["المرفق", "العنق", "الرسغ", "الجمجمة"], correctAnswer: "الجمجمة", category: "جهاز هيكلي" },
    { text: "أي الفيتامينات التالية تصنع في الجلد؟", options: ["فيتامين أ", "فيتامين ج", "فيتامين د", "فيتامين ب"], correctAnswer: "فيتامين د", category: "جلد" },
    { text: "أي جزء من العين يتجمع عليه الضوء؟", options: ["العدسات", "الشبكية", "البؤبؤ", "القرنية"], correctAnswer: "الشبكية", category: "حواس" },
    { text: "أي الأجزاء التالية جزء من الأذن الداخلية؟", options: ["السندان", "المطرقة", "طبلة الأذن", "القوقعة"], correctAnswer: "القوقعة", category: "حواس" },
    { text: "أين تحدث عملية الإخصاب؟", options: ["قناة البيض", "المهبل", "المبيض", "الرحم"], correctAnswer: "قناة البيض", category: "تكاثر" },
    { text: "ما المادة الكيميائية التي تفرزها الغدد الصم؟", options: ["الإنزيم", "الهرمون", "الحمض", "اللعاب"], correctAnswer: "الهرمون", category: "غدد" },
    { text: "أين ينمو الجنين ويتطور؟", options: ["الرحم", "قناة البيض", "المبيض", "المهبل"], correctAnswer: "الرحم", category: "تكاثر" },
    { text: "ماذا يسمى اتحاد البويضة والحيوان المنوي؟", options: ["الأخصاب", "دورة الحيض", "التبويض", "الإنبات"], correctAnswer: "الأخصاب", category: "تكاثر" },
    { text: "في أي مرحلة يتكون الغشاء الرهلي؟", options: ["البويضة المخصبة", "المرحلة الجنينية المتأخرة", "المرحلة الجنينية الأولى", "حديث الولادة"], correctAnswer: "المرحلة الجنينية الأولى", category: "تكاثر" },
    { text: "إحدى الغدد الآتية ليست غدة صماء:", options: ["اللعابية", "النخامية", "الزعترية", "الصنوبرية"], correctAnswer: "اللعابية", category: "غدد" },
    { text: "أي العبارات التالية غير صحيحة فيما يتعلق بالتوائم المتماثلة؟", options: ["ينتجان عن بويضة واحدة", "يحتويان على المادة الوراثية نفسها", "قد يختلفان في الجنس", "لهما الصفات الشكلية نفسها"], correctAnswer: "قد يختلفان في الجنس", category: "وراثة" },
    { text: "في أي شهر يمكن معرفة جنس الجنين؟", options: ["الثاني", "الخامس", "الرابع", "السابع"], correctAnswer: "الرابع", category: "تكاثر" },
    { text: "الغدة التي تسيطر على معظم النشاطات الحيوية في الجسم هي:", options: ["الغدة النخامية", "الغدة الدرقية", "الخصيتان", "الغدة الكظرية"], correctAnswer: "الغدة النخامية", category: "غدد" },
    { text: "أي مما يلي لا تفرزه الغدد العرقية؟", options: ["الماء", "الدهون", "الفضلات", "الأملاح"], correctAnswer: "الدهون", category: "إخراج" },
    { text: "أي الغدد الآتية توجد في العنق؟", options: ["النخامية", "الكظرية", "الدرقية", "البنكرياس"], correctAnswer: "الدرقية", category: "غدد" },
    { text: "يتم إنتاج البويضات في:", options: ["المبيض", "الرحم", "قناة البيض", "المهبل"], correctAnswer: "المبيض", category: "تكاثر" },
    { text: "ما الفتحات الصغيرة الموجودة على سطح الورقة ومحاطة بخلايا حارسة؟", options: ["الثغور", "الكيوتيكل", "البذور", "الريزومات"], correctAnswer: "الثغور", category: "نبات" },
    { text: "أي أجزاء النبات يعمل على تثبيته في التربة؟", options: ["الساق", "الجذر", "الأوراق", "الأزهار"], correctAnswer: "الجذر", category: "نبات" },
    { text: "يتكون معظم اللحاء والخشب الجديد للنباتات في:", options: ["الكامبيوم", "الثغور", "الكيوتيكل", "الخلايا الحارسة"], correctAnswer: "الكامبيوم", category: "نبات" },
    { text: "أي النباتات التالية لها تراكيب تنقل عن طريقها الماء والمواد الأخرى؟", options: ["الوعائية", "اللاوعائية", "الحزازيات", "حشيشة الكبد"], correctAnswer: "الوعائية", category: "نبات" },
    { text: "أي أجزاء الورقة يحدث فيها معظم مراحل عملية البناء الضوئي؟", options: ["البشرة", "الثغور", "الكيوتيكل", "الطبقة العمادية"], correctAnswer: "الطبقة العمادية", category: "نبات" },
    { text: "أي المخلوقات الآتية متعددة الخلايا؟", options: ["الطحالب النارية", "الفطريات الدعامية", "البكتيريا", "الأميبا"], correctAnswer: "الفطريات الدعامية", category: "تصنيف" },
    { text: "أي أعضاء الجهاز البولي يجتمع فيه البول؟", options: ["المثانة", "الكلية", "الحالب", "الإحليل"], correctAnswer: "المثانة", category: "جهاز بولي" },
    { text: "أي الأمراض التالية يسببها فيروس؟", options: ["القرحة", "الملاريا", "السل", "الإنفلونزا"], correctAnswer: "الإنفلونزا", category: "أمراض" },

    // --- العلوم الفيزيائية (أسئلة مرسلة + بنك) ---
    { text: "ماذا يحدث لمعظم المواد عندما يتم تسخينها؟", options: ["تتقلص", "تتمدد", "تطفو", "تتبخر"], correctAnswer: "تتمدد", category: "حرارة" },
    { text: "انتقال الحرارة من الشمس إلى الأرض مثال على:", options: ["الإشعاع", "الحمل الحراري", "التمدد", "التوصيل الحراري"], correctAnswer: "الإشعاع", category: "طاقة" },
    { text: "مجموع طاقتي الوضع والحركة لجميع جزيئات الجسم يسمى:", options: ["درجة الحرارة", "طاقة حركية", "حرارة نوعية", "طاقة حرارية"], correctAnswer: "طاقة حرارية", category: "طاقة" },
    { text: "متوسط الطاقة الحركية للجزيئات المكونة للجسم يعبر عن:", options: ["الطاقة الحرارية", "طاقة الوضع", "درجة الحرارة", "الطاقة الضوئية"], correctAnswer: "درجة الحرارة", category: "حرارة" },
    { text: "يقاس التردد بوحدة:", options: ["هرتز", "ديسبل", "متر / ثانية", "نيوتن"], correctAnswer: "هرتز", category: "موجات" },
    { text: "ينتقل الصوت أسرع ما يمكن في:", options: ["الفراغ", "الماء", "الفولاذ", "الهواء"], correctAnswer: "الفولاذ", category: "صوت" },
    { text: "ما الذي يولد الموجات؟", options: ["الاهتزازات", "الصوت", "الحرارة", "نقل الطاقة"], correctAnswer: "الاهتزازات", category: "موجات" },
    { text: "أي التحولات يحدث في محرك السيارة عندما تبدأ بالحركة؟", options: ["كيميائية - حرارية", "كيميائية - ميكانيكية", "كيميائية - ضوئية", "كيميائية - صوتية"], correctAnswer: "كيميائية - ميكانيكية", category: "تحولات الطاقة" },
    { text: "سلط خالد كشافاً ضوئياً على منشور زجاجي، ما اللون الذي لاحظ أنه ينحرف بشكل أكبر؟", options: ["الأحمر لأن طوله الموجي كبير", "الأزرق لأن طوله الموجي كبير", "الأحمر لأن طوله الموجي صغير", "الأزرق لأن طوله الموجي صغير"], correctAnswer: "الأزرق لأن طوله الموجي صغير", category: "ضوء" },
    { text: "عند سقوط حجر على الأرض، الحجر والأرض يجذبان بعضهما، ما تفسير ذلك؟", options: ["قانون نيوتن الثالث (لكل فعل رد فعل)", "أن محصلة القوى صفر", "أن الجاذبية تعمل في اتجاه واحد", "قصور ذاتي"], correctAnswer: "قانون نيوتن الثالث (لكل فعل رد فعل)", category: "قوى" },
    { text: "على ماذا نحصل عند مزج الملح في الماء؟", options: ["عنصر", "مركب", "جزيء", "محلول"], correctAnswer: "محلول", category: "كيمياء" },
    { text: "ما المحلول غير المتجانس من المحاليل التالية؟", options: ["الأسيتون في الماء", "السكر في الماء", "الطباشير في الماء", "الكحول في الماء"], correctAnswer: "الطباشير في الماء", category: "محاليل" },

    // --- علوم الأرض والفضاء (أسئلة مرسلة + بنك) ---
    { text: "أي الموارد التالية يعتبر مورداً متجدداً؟", options: ["الفحم", "الألومنيوم", "ضوء الشمس", "النفط"], correctAnswer: "ضوء الشمس", category: "موارد" },
    { text: "أي مما يلي يستطيع تحويل الطاقة الضوئية إلى طاقة كهربائية؟", options: ["الضباب الدخاني", "محطات الطاقة النووية", "محطات طاقة الحرارة الجوفية", "الخلايا الشمسية"], correctAnswer: "الخلايا الشمسية", category: "طاقة" },
    { text: "أي مما يلي يسهم في تحلل الأوزون؟", options: ["ثاني أكسيد الكربون", "الرادون", "الكلوروفلوروكربون", "أول أكسيد الكربون"], correctAnswer: "الكلوروفلوروكربون", category: "بيئة" },
    { text: "لو لم تكن هناك ظاهرة الاحتباس الحراري، فأي العبارات التالية صحيحة؟", options: ["سيكون سطح الأرض أكثر سخونة", "سيكون سطح الأرض أكثر برودة", "تكون درجة حرارة الأرض متساوية", "قد ينصهر الغطاء الجليدي"], correctAnswer: "سيكون سطح الأرض أكثر برودة", category: "بيئة" },
    { text: "ماذا تسمى الصخور المنصهرة التي تتدفق على سطح الأرض؟", options: ["الحمم", "اللابة", "الصدع", "الماجما"], correctAnswer: "اللابة", category: "براكين" },
    { text: "يعد القطن من الموارد الطبيعية المتجددة لأنه:", options: ["ينمو بكميات كبيرة", "يُحصد كل عام (يمكن زراعته مجدداً)", "يمكن الحصول عليه صناعياً", "لا يحتاج لضوء الشمس"], correctAnswer: "يُحصد كل عام (يمكن زراعته مجدداً)", category: "موارد" },
    { text: "تتكون شقوق حفر الانهدام عند حدود الصفائح:", options: ["المتقاربة", "الجانبية", "المتباعدة", "الاندساسية"], correctAnswer: "المتباعدة", category: "جيولوجيا" },
    { text: "أي طبقات الغلاف الجوي تحتوي على طبقة الأوزون؟", options: ["التروبوسفير", "الستراتوسفير", "الميزوسفير", "الثيرموسفير"], correctAnswer: "الستراتوسفير", category: "بيئة" },
    { text: "النقطة التي تبدأ عندها حركة الزلزال في باطن الأرض هي:", options: ["المركز السطحي", "الصدع", "البؤرة", "مقياس ريختر"], correctAnswer: "البؤرة", category: "زلازل" }
  ]
};

export const getOutcomesByGrade = (grade: Grade): string[] => {
  return [LearningOutcomes.GENERAL, LearningOutcomes.LIFE, LearningOutcomes.PHYSICAL, LearningOutcomes.EARTH_SPACE];
};

export const generateScienceQuestions = (grade: Grade, count: number = 10, outcomeFilter?: string): Question[] => {
  const fullBank = scienceBank[grade] || [];
  
  let pool: Omit<Question, 'id'>[] = [];

  // تطبيق الفلتر
  if (outcomeFilter && outcomeFilter !== LearningOutcomes.GENERAL) {
    pool = fullBank.filter(q => getOutcomeForCategory(grade, q.category || "") === outcomeFilter);
  } else {
    pool = fullBank;
  }

  // ضمان وجود 10 أسئلة على الأقل
  if (pool.length < count) {
    // إذا كان الفلتر ضيقاً جداً، نملأ النقص من البنك الكامل لنفس الصف
    const additionalNeeded = count - pool.length;
    const remaining = fullBank.filter(q => !pool.includes(q));
    pool = [...pool, ...shuffleArray(remaining).slice(0, additionalNeeded)];
  }

  // خلط الأسئلة واختيار العدد المطلوب
  const selectedQuestions = shuffleArray(pool).slice(0, count);

  // خلط الخيارات لكل سؤال لضمان عدم ثبات الإجابة الصحيحة
  return selectedQuestions.map((q, index) => {
    return {
      ...q,
      id: index + 1,
      options: shuffleArray(q.options || [])
    };
  });
};

export const getEnrichingFacts = (grade: Grade, count: number = 6): ScienceFact[] => {
  const facts: Record<Grade, ScienceFact[]> = {
    [Grade.PRI_3]: [
      { title: "الأرض الزرقاء", description: "يسمى كوكب الأرض بالكوكب الأزرق لأن الماء يغطي أكثر من 70% من سطحه.", category: "earth" },
      { title: "الجاذبية", description: "الجاذبية هي القوة الخفية التي تبقي أقدامنا ثابتة على الأرض!", category: "physics" }
    ],
    [Grade.PRI_6]: [
      { title: "المصنع الأخضر", description: "البلاستيدات الخضراء في أوراق الشجر هي التي تصنع الغذاء لكل الكائنات الحية!", category: "biology" },
      { title: "سرعة الضوء", description: "الضوء سريع جداً لدرجة أنه يمكنه الدوران حول الأرض 7 مرات في ثانية واحدة!", category: "physics" }
    ],
    [Grade.INT_3]: [
      { title: "الـ DNA المذهل", description: "لو قمت بفك شريط الـ DNA في خلية واحدة، سيصل طوله إلى مترين!", category: "biology" },
      { title: "حلقة النار", description: "منطقة حول المحيط الهادئ تحتوي على 75% من براكين العالم النشطة.", category: "earth" },
      { title: "النجوم البعيدة", description: "نحن ننظر إلى الماضي عندما نراقب النجوم، لأن ضوءها يستغرق سنوات ليصل إلينا.", category: "space" }
    ]
  };

  const pool = facts[grade] || facts[Grade.PRI_3];
  return shuffleArray(pool).slice(0, count);
};
