
import { Grade, Question } from '../types';

export interface ScienceFact {
  title: string;
  description: string;
  category: 'biology' | 'physics' | 'chemistry' | 'earth' | 'space';
}

export const LearningOutcomes = {
  GENERAL: "اختبار شامل",
  LIFE: "علوم الحياة",
  PHYSICAL: "العلوم الفيزيائية",
  EARTH_SPACE: "علوم الأرض والفضاء",
  THINKING_SKILLS: "مهارات التفكير العلمي"
};

/**
 * دالة لربط فئة السؤال بناتج التعلم المناسب حسب الصف الدراسي
 * تضمن هذه الدالة تصنيفاً صارماً لكل سؤال في مجاله الصحيح فقط
 */
const getOutcomeForCategory = (grade: Grade, category: string): string => {
  const cat = category.toLowerCase();
  
  // 1. علوم الحياة
  if ([
    "الخلايا", "الخلية", "الوراثة", "جينات", "مندل", "انقسام", "dna", "rna",
    "أجهزة", "جسم الإنسان", "الجهاز الهضمي", "الجهاز البولي", "الجهاز الدوري", "الجهاز التنفسي",
    "تصنيف", "الممالك", "المناعة", "دورة الحياة", "أنظمة بيئية", "الأحياء", "التكاثر", 
    "الغدد", "العظام", "الحواس", "البكتيريا", "النباتات", "التمثيل الضوئي", "الحيوانات",
    "نمو", "تغذية", "موطن", "سلسلة غذائية", "المخلوقات الحية"
  ].includes(cat)) return LearningOutcomes.LIFE;

  // 2. العلوم الفيزيائية
  if ([
    "المادة", "كيمياء", "فيزياء", "ذرة", "روابط", "محفزات", "تفاعل", "المحاليل",
    "الحركة", "القوى", "نيوتن", "السرعة", "التسارع", "الزخم", "احتكاك", "جاذبية",
    "الطاقة", "الشغل", "حرارة", "توصيل", "إشعاع", "كهرباء", "مغناطيس", "تيار", "مولد",
    "الموجات", "صوت", "ضوء", "انعكاس", "انكسار", "البصريات", "الكهرومغناطيسية", "مخاليط",
    "الذرة", "الجدول الدوري", "الأحماض", "القواعد", "تفاعلات"
  ].includes(cat)) return LearningOutcomes.PHYSICAL;

  // 3. علوم الأرض والفضاء
  if ([
    "فضاء", "القمر", "الشمس", "الفصول", "مجرات", "كواكب", "تلسكوب",
    "معالم الأرض", "صخور", "زلازل", "براكين", "صفائح", "التجوية", "التعرية",
    "الطقس", "الغلاف الجوي", "بيئة", "تلوث", "موارد", "نشاط بشري", "احتباس حراري",
    "أوزون", "اللابة", "نجوم", "دوران", "تربة", "المجرات", "المذنب", "البقع الساخنة"
  ].includes(cat)) return LearningOutcomes.EARTH_SPACE;

  return LearningOutcomes.LIFE;
};

const scienceBank: Record<Grade, Omit<Question, 'id'>[]> = {
  [Grade.PRI_3]: [
    { text: "ما هو الجزء الذي يثبت النبات في التربة؟", options: ["الأوراق", "الجذور", "الأزهار", "الثمار"], correctAnswer: "الجذور", category: "النباتات" },
    { text: "تحتاج النباتات لتنمو إلى الضوء و الماء و:", options: ["الحليب", "الهواء", "العصير", "الظل"], correctAnswer: "الهواء", category: "النباتات" },
    { text: "أين تعيش الحيوانات التي لها خياشيم وزعانف؟", options: ["في الصحراء", "في الماء", "في الغابة", "على الجبال"], correctAnswer: "في الماء", category: "الحيوانات" },
    { text: "أي مما يلي يعد من أجزاء الزهرة؟", options: ["الجذر", "البتلة", "الساق", "اللحاء"], correctAnswer: "البتلة", category: "النباتات" },
    { text: "ما الذي يغطي جسم الطيور؟", options: ["الفرو", "الريش", "القشور", "الجلد"], correctAnswer: "الريش", category: "الحيوانات" },
    { text: "تسمى الحيوانات التي تأكل النباتات فقط بـ:", options: ["آكلة اللحوم", "آكلة الأعشاب", "القوارض", "المفترسات"], correctAnswer: "آكلة الأعشاب", category: "الحيوانات" },
    { text: "المكان الذي يعيش فيه المخلوق الحي يسمى:", options: ["الموطن", "الفضاء", "المعمل", "السوق"], correctAnswer: "الموطن", category: "الأحياء" },
    { text: "أي من المواد التالية صلبة؟", options: ["الماء", "الخشب", "الهواء", "الزيت"], correctAnswer: "الخشب", category: "المادة" },
    { text: "ما هي القوة التي تسحب الأجسام نحو الأرض؟", options: ["الكهرباء", "الجاذبية", "المغناطيسية", "الدفع"], correctAnswer: "الجاذبية", category: "القوى" },
    { text: "أي كوكب نعيش عليه؟", options: ["المريخ", "الأرض", "زحل", "المشتري"], correctAnswer: "الأرض", category: "كواكب" }
  ],
  [Grade.PRI_6]: [
    { text: "الوحدة الأساسية للحياة في المخلوق الحي هي:", options: ["النسيج", "الخلية", "الجهاز", "العضو"], correctAnswer: "الخلية", category: "الخلايا" },
    { text: "الغاز الناتج عن عملية البناء الضوئي هو:", options: ["الهيدروجين", "الأوكسجين", "النيتروجين", "ثاني أكسيد الكربون"], correctAnswer: "الأوكسجين", category: "التمثيل الضوئي" },
    { text: "تعد مهارة الرسم من الصفات:", options: ["الموروثة", "المكتسبة", "الغريزية", "المتنحية"], correctAnswer: "المكتسبة", category: "الوراثة" },
    { text: "تمثل التراكيب التالية (العظام - الدم - الغضاريف - الدهون):", options: ["خلايا", "أنسجة", "أعضاء", "أجهزة حيوية"], correctAnswer: "أنسجة", category: "أجهزة" },
    { text: "تتكون البروتينات من الكربون والهيدروجين والنيتروجين، لذا تصنف بأنها:", options: ["عنصر", "ذرة", "مركب", "مخلوط"], correctAnswer: "مركب", category: "المادة" },
    { text: "عندما يسقط المظلي، تتباطأ سرعته بسبب:", options: ["الجاذبية", "مقاومة الهواء", "القصور الذاتي", "الوزن"], correctAnswer: "مقاومة الهواء", category: "القوى" },
    { text: "يحدث كسوف الشمس عندما يقع ______ بين الأرض والشمس.", options: ["المريخ", "المشتري", "القمر", "الزهرة"], correctAnswer: "القمر", category: "فضاء" }
  ],
  [Grade.INT_3]: [
    // --- علوم الحياة (ثالث متوسط) ---
    { text: "ما هي أصغر وحدة تركيبية ووظيفية في جسم الكائن الحي؟", options: ["الكروموسوم", "الخلية", "جهاز كولجي", "النسيج"], correctAnswer: "الخلية", category: "الخلايا" },
    { text: "أي من المخلوقات التالية تعتبر متعددة الخلايا؟", options: ["البكتيريا", "الطحالب النارية", "الفطريات الدعامية", "الأميبا"], correctAnswer: "الفطريات الدعامية", category: "المخلوقات الحية" },
    { text: "في أي أجزاء الخلية التالية يخزن الغذاء والماء والفضلات؟", options: ["الفجوة", "النواة", "الميتوكندريا", "السيتوبلازم"], correctAnswer: "الفجوة", category: "الخلايا" },
    { text: "ما أهمية الانقسام المتساوي؟", options: ["ينتج عنه انقسام النواة", "يؤدي لاختفاء الخلايا الأصلية", "ينسخ المادة الوراثية", "يسمح بتعويض الخلايا التالفة"], correctAnswer: "يسمح بتعويض الخلايا التالفة", category: "انقسام" },
    { text: "تصطف أزواج الكروماتيدات في وسط الخلية في الطور:", options: ["الاستوائي", "التمهيدي", "النهائي", "الانفصالي"], correctAnswer: "الاستوائي", category: "انقسام" },
    { text: "تنتج الخلايا الأحادية المجموعة الكروموسومية خلال عملية:", options: ["التبرعم", "الانقسام المنصف", "التكاثر اللا جنسي", "الانقسام المتساوي"], correctAnswer: "الانقسام المنصف", category: "انقسام" },
    { text: "أي الأجهزة التالية يعمل على الموازنة بين كميات الأملاح والماء في الجسم؟", options: ["التنفسي", "المناعي", "الهضمي", "البولي"], correctAnswer: "البولي", category: "أجهزة" },
    { text: "أي الأمراض التالية ينتج عن وجود خلل في الجهاز التنفسي؟", options: ["الربو", "الفشل الكلوي", "اللوكيميا", "الأنيميا"], correctAnswer: "الربو", category: "جسم الإنسان" },
    { text: "كان العالم مندل أول من تتبع:", options: ["أكثر من صفة في التجربة", "صفة واحدة عبر أكثر من جيل", "صفة واحدة في جيل واحد", "الجينات فقط"], correctAnswer: "صفة واحدة عبر أكثر من جيل", category: "الوراثة" },
    { text: "أي مما يلي هو المسؤول عن صفة وراثية محددة؟", options: ["الأليل", "الخلايا الجنسية", "العامل السائد", "الكروموسومات"], correctAnswer: "الأليل", category: "الوراثة" },
    { text: "الجزيء الذي يحمل الشفرة الوراثية للمخلوق الحي هو:", options: ["atp", "rna", "dna", "البروتين"], correctAnswer: "dna", category: "الوراثة" },
    { text: "عدد الكروموسومات في الخلايا الجنسية للإنسان تساوي:", options: ["46 كروموسوم", "23 كروموسوم", "8 كروموسومات", "12 كروموسوم"], correctAnswer: "23 كروموسوم", category: "الخلايا" },

    // --- العلوم الفيزيائية (ثالث متوسط) ---
    { text: "صور طومسون الذرة في نموذجه على أنها:", options: ["نواة موجبة تحيط بها الكترونات", "كرة من الشحنات الموجبة تنتشر فيها إلكترونات سالبة", "فراغ يحتوي على بروتونات", "سحابة الكترونية فقط"], correctAnswer: "كرة من الشحنات الموجبة تنتشر فيها إلكترونات سالبة", category: "الذرة" },
    { text: "النيوترون هو جسم له كتلة مساوية لكتلة البروتون لكنه:", options: ["موجب الشحنة", "سالب الشحنة", "متعادل كهربائياً", "عديم الكتلة"], correctAnswer: "متعادل كهربائياً", category: "الذرة" },
    { text: "ما الخاصية التي تنطبق دائماً على المركب الكيميائي؟", options: ["لا تختلف خواصه عن عناصره", "تتغير نسب مواده دون تبدل ماهيته", "لا يمكن تغيير نسب مواده دون تبدل ماهيته", "ينفصل بالترشيح دائماً"], correctAnswer: "لا يمكن أن تتغير نسب مواده دون تبدل ماهيته", category: "المادة" },
    { text: "تعد المشروبات الغازية مثالاً على محلول:", options: ["سائل في سائل", "غاز في سائل", "صلب في سائل", "غاز في غاز"], correctAnswer: "غاز في سائل", category: "المحاليل" },
    { text: "أي العوامل التالية يقلل من ذائبية المادة الصلبة؟", options: ["زيادة الحرارة", "التحريك", "سحق المذاب", "خفض درجة الحرارة"], correctAnswer: "خفض درجة الحرارة", category: "المحاليل" },
    { text: "تسمى الرابطة التي تنشأ بين اللافلزات من خلال التشارك بالإلكترونات:", options: ["الأيونية", "التساهمية", "القطبية", "الفلزية"], correctAnswer: "التساهمية", category: "روابط" },
    { text: "يسمى الحد الأدنى من الطاقة اللازم لبدء التفاعل الكيميائي بـ:", options: ["طاقة التنشيط", "الطاقة الحرارية", "طاقة الوضع", "الطاقة الضوئية"], correctAnswer: "طاقة التنشيط", category: "تفاعل" },
    { text: "وحدة قياس القدرة الكهربائية في الدوائر هي:", options: ["فولت", "أوم", "واط", "أمبير"], correctAnswer: "واط", category: "كهرباء" },
    { text: "مجموع طاقتي الوضع والحركة لجميع جزيئات الجسم تسمى:", options: ["درجة الحرارة", "الطاقة الحرارية", "الحرارة النوعية", "الكمون الحراري"], correctAnswer: "الطاقة الحرارية", category: "الطاقة" },

    // --- علوم الأرض والفضاء (ثالث متوسط) ---
    { text: "تستعمل المناظير الفلكية الراديوية في:", options: ["دراسة الموجات الراديوية من الفضاء", "سماع الأخبار الأرضية", "رؤية الكواكب القريبة فقط", "قياس سرعة الرياح"], correctAnswer: "دراسة الموجات الراديوية من الفضاء", category: "تلسكوب" },
    { text: "يتكون المذنب من الصخور والجليد والغبار ويتحرك حول:", options: ["الأرض", "الشمس", "القمر", "المشتري"], correctAnswer: "الشمس", category: "المذنب" },
    { text: "أي الكواكب التالية يتميز بوجود فصول مختلفة وجليد عند قطبيه؟", options: ["المريخ", "أورانوس", "الزهرة", "عطارد"], correctAnswer: "المريخ", category: "كواكب" },
    { text: "الغاز الرئيسي المسؤول عن ظاهرة الاحتباس الحراري هو:", options: ["النيتروجين", "الهيدروجين", "ثاني أكسيد الكربون", "الأوكسجين"], correctAnswer: "ثاني أكسيد الكربون", category: "احتباس حراري" },
    { text: "ما هي الخصائص المشتركة للصخور الرسوبية؟", options: ["تتكون من تبخر الماء", "تتكون من رمال الشاطئ فقط", "تتكون من حبيبات", "تتكون من صخور منصهرة"], correctAnswer: "تتكون من حبيبات", category: "صخور" },
    { text: "تسمى النقطة داخل الأرض التي يبدأ عندها تحرر الطاقة والزلزال بـ:", options: ["المركز السطحي", "البؤرة", "الصدع", "الموجة الأولية"], correctAnswer: "البؤرة", category: "زلازل" },
    { text: "تتكون شقوق حفر الانهدام عند:", options: ["تقارب الصفائح", "تباعد الصفائح", "انزلاق الصفائح", "ثبات الصفائح"], correctAnswer: "تباعد الصفائح", category: "صفائح" },
    { text: "تقدم تيارات الحمل الحراري في باطن الأرض تفسيراً لـ:", options: ["حركة الصفائح الأرضية", "البقع الساخنة", "الزلازل فقط", "تكون الرياح"], correctAnswer: "حركة الصفائح الأرضية", category: "صفائح" }
  ]
};

export const getOutcomesByGrade = (grade: Grade): string[] => {
  const outcomes = [LearningOutcomes.GENERAL];
  if (grade === Grade.INT_3 || grade === Grade.PRI_6 || grade === Grade.PRI_3) {
    outcomes.push(LearningOutcomes.LIFE, LearningOutcomes.PHYSICAL, LearningOutcomes.EARTH_SPACE);
  }
  return outcomes;
};

export const generateScienceQuestions = (grade: Grade, count: number = 10, outcomeFilter?: string): Question[] => {
  const fullBank = scienceBank[grade] || [];
  
  const shuffle = (array: any[]) => {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  };

  let pool: Omit<Question, 'id'>[] = [];

  if (outcomeFilter && outcomeFilter !== LearningOutcomes.GENERAL) {
    pool = fullBank.filter(q => getOutcomeForCategory(grade, q.category || "") === outcomeFilter);
    pool = shuffle(pool);
  } else {
    pool = shuffle(fullBank);
  }

  const finalSelection = pool.slice(0, count);

  return finalSelection.map((q, index) => ({
    ...q,
    id: index + 1
  }));
};

export const getEnrichingFacts = (grade: Grade, count: number = 6): ScienceFact[] => {
  const facts: Record<Grade, ScienceFact[]> = {
    [Grade.PRI_3]: [
      { title: "الأرض الزرقاء", description: "يسمى كوكب الأرض بالكوكب الأزرق لأن الماء يغطي أكثر من 70% من سطحه.", category: "earth" },
      { title: "الجاذبية", description: "الجاذبية هي القوة الخفية التي تبقي أقدامنا ثابتة على الأرض وتمنعنا من الطيران في الفضاء!", category: "physics" }
    ],
    [Grade.PRI_6]: [
      { title: "المصنع الأخضر", description: "البلاستيدات الخضراء في أوراق الشجر هي التي تصنع الغذاء لكل الكائنات الحية تقريباً عبر البناء الضوئي!", category: "biology" },
      { title: "سرعة الضوء", description: "الضوء سريع جداً لدرجة أنه يمكنه الدوران حول الأرض 7 مرات في ثانية واحدة فقط!", category: "physics" }
    ],
    [Grade.INT_3]: [
      { title: "الـ DNA المذهل", description: "لو قمت بفك شريط الـ DNA الموجود في خلية واحدة، سيصل طوله إلى مترين تقريباً!", category: "biology" },
      { title: "حلقة النار", description: "منطقة حول المحيط الهادئ تسمى حلقة النار لأنها تحتوي على 75% من براكين العالم النشطة.", category: "earth" },
      { title: "العناصر الكيميائية", description: "جسم الإنسان يتكون من نفس العناصر الكيميائية الموجودة في النجوم البعيدة!", category: "chemistry" }
    ]
  };

  const pool = facts[grade] || facts[Grade.PRI_3];
  return [...pool].sort(() => 0.5 - Math.random()).slice(0, count);
};
