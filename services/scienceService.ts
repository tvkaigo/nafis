
import { Grade, Question } from '../types';

export interface ScienceFact {
  title: string;
  description: string;
  category: 'biology' | 'physics' | 'chemistry' | 'earth' | 'space';
}

export const LearningOutcomes = {
  GENERAL: "اختبار شامل",
  LIFE: "علوم الحياة",
  PHYSICAL: "العلوم الفيزيائية",
  EARTH_SPACE: "علوم الأرض والفضاء",
  THINKING_SKILLS: "مهارات التفكير العلمي"
};

/**
 * دالة لربط فئة السؤال بناتج التعلم المناسب حسب الصف الدراسي
 */
const getOutcomeForCategory = (grade: Grade, category: string): string => {
  if (grade === Grade.INT_3 || grade === Grade.PRI_6) {
    // 1. علوم الحياة
    if ([
      "الخلية", "الخلايا", "الوراثة", "جينات", "مندل", "انقسام", "DNA", 
      "أجهزة", "جسم الإنسان", "الجهاز الهضمي", "تصنيف", "الممالك", "المناعة",
      "دورة الحياة", "أنظمة بيئية", "الأحياء", "التكاثر", "الغدد", "العظام", "الحواس"
    ].includes(category)) return LearningOutcomes.LIFE;

    // 2. العلوم الفيزيائية
    if ([
      "المادة", "كيمياء", "فيزياء", "ذرة", "روابط", "محفزات", "تفاعل", "المحاليل",
      "الحركة", "القوى", "نيوتن", "السرعة", "التسارع", "الزخم", "احتكاك", "جاذبية",
      "الطاقة", "الشغل", "حرارة", "توصيل", "كهرباء", "مغناطيس", "تيار", "مولد",
      "الموجات", "صوت", "ضوء", "انعكاس", "انكسار", "الكهرومغناطيسية", "البصريات"
    ].includes(category)) return LearningOutcomes.PHYSICAL;

    // 3. علوم الأرض والفضاء
    if ([
      "فضاء", "القمر", "الشمس", "الفصول", "مجرات", "كواكب", "تلسكوب",
      "معالم الأرض", "صخور", "زلازل", "براكين", "صفائح", "التجوية", "التعرية",
      "الطقس", "الغلاف الجوي", "بيئة", "تلوث", "موارد", "نشاط بشري", "احتباس حراري"
    ].includes(category)) return LearningOutcomes.EARTH_SPACE;
  }

  if (grade === Grade.PRI_3) {
    if (["النباتات", "الأحياء"].includes(category)) return LearningOutcomes.LIFE;
    if (["المادة", "القوى"].includes(category)) return LearningOutcomes.PHYSICAL;
    return LearningOutcomes.EARTH_SPACE;
  }

  return LearningOutcomes.LIFE;
};

const scienceBank: Record<Grade, Omit<Question, 'id'>[]> = {
  [Grade.PRI_3]: [
    { text: "ما هو الجزء الذي يثبت النبات في التربة؟", options: ["الأوراق", "الجذور", "الأزهار", "الثمار"], correctAnswer: "الجذور", category: "النباتات" },
    { text: "تحتاج النباتات لتنمو إلى الضوء و الماء و:", options: ["الحليب", "الهواء", "العصير", "الظل"], correctAnswer: "الهواء", category: "النباتات" }
  ],
  [Grade.PRI_6]: [
    { text: "الوحدة الأساسية للحياة، وأصغر جزء في المخلوق الحي قادر على الحياة هي:", options: ["النسيج", "الخلية", "الجهاز الحيوي", "الخاصية الأسموزية"], correctAnswer: "الخلية", category: "الخلايا" },
    { text: "يوجد في الخلية بين النواة والغشاء البلازمي مادة تشبه الهلام تسمى:", options: ["الغشاء الخلوي", "الجدار الخلوي", "السيتوبلازم", "الكروموسوم"], correctAnswer: "السيتوبلازم", category: "الخلايا" },
    { text: "ارتداد الضوء عن السطوح يسمى:", options: ["انكساره", "انعكاسه", "امتصاصه", "تفريقه"], correctAnswer: "انعكاسه", category: "الموجات" },
    { text: "يسمى شكل القمر الذي نراه في السماء ليلاً في اليوم الأول من الشهر القمري:", options: ["محاقاً", "هلالاً أول", "تربيعاً أول", "أحدب أول"], correctAnswer: "محاقاً", category: "القمر" }
  ],
  [Grade.INT_3]: [
    // --- علوم الحياة (أسئلة جديدة) ---
    { text: "ما الذي يتكون في الدم لمحاربة مولدات الضد؟", options: ["الهرمونات", "المواد المسببة للحساسية", "مسببات المرض", "الأجسام المضادة"], correctAnswer: "الأجسام المضادة", category: "المناعة" },
    { text: "أي الأمراض التالية سببه فيروس يهاجم خلايا الدم البيضاء؟", options: ["الإيدز", "الحصبة", "الإنفلونزا", "شلل الأطفال"], correctAnswer: "الإيدز", category: "المناعة" },
    { text: "أي المواد الغذائية التالية تصنعها البكتيريا في الأمعاء الغليظة؟", options: ["الدهون", "الفيتامينات", "الأملاح المعدنية", "البروتينات"], correctAnswer: "الفيتامينات", category: "الجهاز الهضمي" },
    { text: "إلى أي المجموعات الغذائية ينتمي اللبن والحليب؟", options: ["الأطعمة الغنية بالكالسيوم", "البروتينات", "الحبوب", "الفواكه"], correctAnswer: "الأطعمة الغنية بالكالسيوم", category: "جسم الإنسان" },
    { text: "أي مما يلي ينقبض عند الشهيق ويتحرك إلى أسفل؟", options: ["الشعبتان الهوائيتان", "الحويصلات الهوائية", "الحجاب الحاجز", "القصبة الهوائية"], correctAnswer: "الحجاب الحاجز", category: "جسم الإنسان" },
    { text: "التراكيب التي تحدث بينها وبين الشعيرات الدموية عملية تبادل الغازات هي:", options: ["الحويصلات", "الشعبتان الهوائيتان", "القصبات", "الشعيبات"], correctAnswer: "الحويصلات", category: "جسم الإنسان" },
    { text: "أي المواد التالية لا يتم إعادة امتصاصها بعد مرورها في الكلية؟", options: ["الأملاح", "الفضلات", "الماء", "السكر"], correctAnswer: "الفضلات", category: "أجهزة" },
    { text: "أي مما يلي يسبب أمراض جهاز الدوران؟", options: ["التدخين", "استخدام مادة الاسبست", "الجري", "التعرض للأشعة فوق بنفسجية"], correctAnswer: "التدخين", category: "أجهزة" },
    { text: "أي مما يلي يعد من وظائف الدم؟", options: ["إفراز الأملاح خارج الجسم", "إفراز اللعاب في الفم", "نقل المواد الغذائية إلى خلايا الجسم", "التخلص من اللمف المحيط بالخلايا"], correctAnswer: "نقل المواد الغذائية إلى خلايا الجسم", category: "جسم الإنسان" },
    { text: "أي مما يلي يسببه التدخين؟", options: ["سرطان الرئة", "السكري", "الإنفلونزا", "التهاب المثانة"], correctAnswer: "سرطان الرئة", category: "جسم الإنسان" },
    { text: "أي من الأمراض التالية يعد مرضاً غير معدٍ؟", options: ["التيتانوس", "الإنفلونزا", "الملاريا", "السكري"], correctAnswer: "السكري", category: "المناعة" },
    { text: "أين تنتج خلايا الدم الحمراء؟", options: ["العظم الكثيف", "الغضروف", "السمحاق", "نخاع العظم"], correctAnswer: "نخاع العظم", category: "العظام" },
    { text: "ماذا يغلف أطراف العظم؟", options: ["الغضروف", "العضلات", "الجلد", "الأوتار"], correctAnswer: "الغضروف", category: "العظام" },
    { text: "توجد المفاصل غير المتحركة في الإنسان في:", options: ["المرفق", "العنق", "الرسغ", "الجمجمة"], correctAnswer: "الجمجمة", category: "العظام" },
    { text: "أي الفيتامينات التالية تصنع في الجلد عند التعرض لأشعة الشمس؟", options: ["فيتامين أ", "فيتامين ج", "فيتامين د", "فيتامين ك"], correctAnswer: "فيتامين د", category: "الأحياء" },
    { text: "أي جزء من العين يتجمع عليه الضوء لتكوين الصورة؟", options: ["العدسة", "الشبكية", "البؤبؤ", "القرنية"], correctAnswer: "الشبكية", category: "الحواس" },
    { text: "أي الأجزاء التالية يعد جزءاً من الأذن الداخلية؟", options: ["السندان", "المطرقة", "طبلة الأذن", "القوقعة"], correctAnswer: "القوقعة", category: "الحواس" },
    { text: "أين تحدث عملية الإخصاب عادة؟", options: ["قناة البيض", "المهبل", "المبيض", "الرحم"], correctAnswer: "قناة البيض", category: "التكاثر" },
    { text: "ما المادة الكيميائية التي تفرزها الغدد الصم في الدم مباشرة؟", options: ["الإنزيم", "الهرمون", "الحمض", "اللعاب"], correctAnswer: "الهرمون", category: "الغدد" },
    { text: "أين ينمو الجنين ويتطور؟", options: ["الرحم", "قناة البيض", "المبيض", "المهبل"], correctAnswer: "الرحم", category: "التكاثر" },
    { text: "ماذا يسمى اتحاد البويضة والحيوان المنوي؟", options: ["الإخصاب", "دورة الحيض", "الانقسام", "التلقيح"], correctAnswer: "الإخصاب", category: "التكاثر" },
    { text: "في أي مرحلة من نمو الجنين يتكون الغشاء الرهلي؟", options: ["البويضة المخصبة", "المرحلة الجنينية المتأخرة", "المرحلة الجنينية الأولى", "حديث الولادة"], correctAnswer: "المرحلة الجنينية الأولى", category: "التكاثر" },
    { text: "إحدى الغدد الآتية ليست غدة صماء:", options: ["اللعابية", "النخامية", "الزعترية", "الصنوبرية"], correctAnswer: "اللعابية", category: "الغدد" },
    { text: "أي العبارات التالية غير صحيحة فيما يتعلق بالتوائم المتماثلة؟", options: ["ينتجان عن بويضة واحدة", "يحتويان على المادة الوراثية نفسها", "قد يختلفان في الجنس", "لهما الصفات الشكلية نفسها"], correctAnswer: "قد يختلفان في الجنس", category: "الوراثة" },
    { text: "في أي شهر من الحمل يمكن عادة معرفة جنس الجنين؟", options: ["الثاني", "الخامس", "الرابع", "السابع"], correctAnswer: "الرابع", category: "التكاثر" },
    { text: "الغدة التي تسيطر على معظم النشاطات الحيوية في الجسم هي:", options: ["الغدة النخامية", "الغدة الدرقية", "الخصيتان", "الغدة الكظرية"], correctAnswer: "الغدة النخامية", category: "الغدد" },
    { text: "أي مما يلي لا تفرزه الغدد العرقية؟", options: ["الماء", "الدهون", "الأملاح", "الفضلات"], correctAnswer: "الدهون", category: "أجهزة" },
    { text: "أي الغدد الآتية توجد في العنق؟", options: ["النخامية", "الكظرية", "الدرقية", "البنكرياس"], correctAnswer: "الدرقية", category: "الغدد" },
    { text: "يتم إنتاج البويضات في:", options: ["المبيض", "الرحم", "قناة البيض", "المهبل"], correctAnswer: "المبيض", category: "التكاثر" },
    { text: "ما الفتحات الصغيرة الموجودة على سطح الورقة ومحاطة بخلايا حارسة؟", options: ["الثغور", "الكيوتيكل", "البذور", "الريزومات"], correctAnswer: "الثغور", category: "الأحياء" },
    { text: "أي أجزاء النبات يعمل على تثبيته في التربة؟", options: ["الساق", "الجذر", "الأوراق", "الأزهار"], correctAnswer: "الجذر", category: "الأحياء" },
    { text: "يتكون معظم اللحاء والخشب الجديد للنباتات في:", options: ["الكامبيوم", "الثغور", "الكيوتيكل", "الخلايا الحارسة"], correctAnswer: "الكامبيوم", category: "الأحياء" },
    { text: "أي النباتات التالية لها تراكيب تنقل عن طريقها الماء والمواد الأخرى؟", options: ["الوعائية", "اللاوعائية", "الحزازيات", "حشيشة الكبد"], correctAnswer: "الوعائية", category: "الأحياء" },
    { text: "أي أجزاء الورقة يحدث فيها معظم مراحل عملية البناء الضوئي؟", options: ["البشرة", "الثغور", "الكيوتيكل", "الطبقة العمادية"], correctAnswer: "الطبقة العمادية", category: "الأحياء" },
    { text: "أي المخلوقات الآتية متعددة الخلايا؟", options: ["الطحالب النارية", "الفطريات الدعامية", "البكتيريا", "الأميبا"], correctAnswer: "الفطريات الدعامية", category: "الخلية" },
    { text: "أي الأعضاء التالية يجتمع فيه البول؟", options: ["المثانة", "الكلية", "الحالب", "الإحليل"], correctAnswer: "المثانة", category: "أجهزة" },
    { text: "أي الأمراض التالية يسببها فيروس؟", options: ["القرحة", "الملاريا", "السل", "الإنفلونزا"], correctAnswer: "الإنفلونزا", category: "المناعة" },

    // --- العلوم الفيزيائية (أسئلة جديدة) ---
    { text: "ماذا يحدث لمعظم المواد عندما يتم تسخينها؟", options: ["تتقلص", "تتمدد", "تطفو", "تتبخر"], correctAnswer: "تتمدد", category: "المادة" },
    { text: "انتقال الحرارة من الشمس إلى الأرض مثال على:", options: ["الإشعاع", "الحمل الحراري", "التمدد", "التوصيل الحراري"], correctAnswer: "الإشعاع", category: "حرارة" },
    { text: "مجموع طاقتي الوضع والحركة لجميع جزيئات الجسم تسمى:", options: ["درجة الحرارة", "طاقة حركية", "حرارة نوعية", "طاقة حرارية"], correctAnswer: "طاقة حرارية", category: "الطاقة" },
    { text: "متوسط الطاقة الحركية للجزيئات المكونة للجسم يعبر عن:", options: ["الطاقة الحرارية", "طاقة الوضع", "درجة الحرارة", "الضغط"], correctAnswer: "درجة الحرارة", category: "الطاقة" },
    { text: "يقاس التردد بوحدة:", options: ["هرتز", "ديسبل", "متر/ثانية", "نيوتن"], correctAnswer: "هرتز", category: "الموجات" },
    { text: "ينتقل الصوت أسرع ما يمكن في:", options: ["الفراغ", "الماء", "الفولاذ", "الهواء"], correctAnswer: "الفولاذ", category: "صوت" },
    { text: "تتولد الموجات نتيجة حدوث:", options: ["الاهتزازات", "الصوت", "الحرارة", "نقل المادة"], correctAnswer: "الاهتزازات", category: "الموجات" },
    { text: "ما سبب تغير شكل المثلجات عند تركها خارج المجمد لفترة؟", options: ["ارتفاع درجة الحرارة", "تغير لونها", "تأثرها بشكل الإناء", "انخفاض الضغط"], correctAnswer: "ارتفاع درجة الحرارة", category: "المادة" },
    { text: "أي التحولات يحدث في محرك السيارة عندما تبدأ بالحركة؟", options: ["كيميائية - حرارية", "كيميائية - ميكانيكية", "كيميائية - ضوئية", "كيميائية - صوتية"], correctAnswer: "كيميائية - ميكانيكية", category: "الطاقة" },
    { text: "سلط خالد كشافاً ضوئياً على منشور زجاجي، أي الألوان ينحرف بشكل أكبر؟", options: ["الأحمر لطوله الموجي الكبير", "الأزرق لطوله الموجي الكبير", "الأحمر لطوله الموجي الصغير", "الأزرق لطوله الموجي الصغير"], correctAnswer: "الأزرق لطوله الموجي الصغير", category: "البصريات" },
    { text: "عند سقوط حجر على الأرض، يجذب كل منهما الآخر، التفسير هو:", options: ["لكل فعل رد فعل مساوٍ له في المقدار ومعاكس في الاتجاه", "محصلة القوى تساوي صفر", "إحدى القوى تساوي صفر", "عدم وجود احتكاك"], correctAnswer: "لكل فعل رد فعل مساوٍ له في المقدار ومعاكس في الاتجاه", category: "نيوتن" },
    { text: "على ماذا نحصل عند مزج الملح في الماء؟", options: ["عنصر", "مركب", "جزيء", "محلول"], correctAnswer: "محلول", category: "المحاليل" },
    { text: "ما المحلول غير المتجانس من المحاليل التالية؟", options: ["الأسيتون في الماء", "السكر في الماء", "الطباشير في الماء", "الكحول في الماء"], correctAnswer: "الطباشير في الماء", category: "المحاليل" },

    // --- علوم الأرض والفضاء (أسئلة جديدة) ---
    { text: "أي الموارد التالية يعد مورداً متجدداً؟", options: ["الفحم", "الألومنيوم", "ضوء الشمس", "النفط"], correctAnswer: "ضوء الشمس", category: "موارد" },
    { text: "أي مما يلي يستطيع تحويل الطاقة الضوئية إلى طاقة كهربائية؟", options: ["الضباب الدخاني", "المحطات النووية", "طاقة الحرارة الجوفية", "الخلايا الشمسية"], correctAnswer: "الخلايا الشمسية", category: "موارد" },
    { text: "أي مما يلي يسهم في تحلل طبقة الأوزون؟", options: ["ثاني أكسيد الكربون", "الرادون", "الكلوروفلوروكربون", "أول أكسيد الكربون"], correctAnswer: "الكلوروفلوروكربون", category: "بيئة" },
    { text: "لو لم تكن هناك ظاهرة الاحتباس الحراري، فماذا سيحدث؟", options: ["سيكون سطح الأرض أكثر سخونة", "سيكون سطح الأرض أكثر برودة", "تكون الحرارة متساوية", "ينصهر الجليد"], correctAnswer: "سيكون سطح الأرض أكثر برودة", category: "بيئة" },
    { text: "ماذا تسمى الصخور المنصهرة التي تتدفق على سطح الأرض؟", options: ["الحمم", "اللابة", "الصدع", "الماجما"], correctAnswer: "اللابة", category: "براكين" },
    { text: "لماذا يعد القطن من الموارد الطبيعية المتجددة؟", options: ["ينمو بكميات كبيرة", "يُحصد كل عام ويمكن زراعته مجدداً", "يمكن الحصول عليه صناعياً", "لا يحتاج لضوء الشمس"], correctAnswer: "يُحصد كل عام ويمكن زراعته مجدداً", category: "موارد" }
  ]
};

export const getOutcomesByGrade = (grade: Grade): string[] => {
  const outcomes = [LearningOutcomes.GENERAL];
  if (grade === Grade.INT_3 || grade === Grade.PRI_6 || grade === Grade.PRI_3) {
    outcomes.push(LearningOutcomes.LIFE, LearningOutcomes.PHYSICAL, LearningOutcomes.EARTH_SPACE);
  }
  return outcomes;
};

export const generateScienceQuestions = (grade: Grade, count: number = 10, outcomeFilter?: string): Question[] => {
  const fullBank = scienceBank[grade] || [];
  
  let primaryPool: Omit<Question, 'id'>[] = [];
  let fallbackPool: Omit<Question, 'id'>[] = [];

  if (outcomeFilter && outcomeFilter !== LearningOutcomes.GENERAL) {
    primaryPool = fullBank.filter(q => getOutcomeForCategory(grade, q.category || "") === outcomeFilter);
    fallbackPool = fullBank.filter(q => getOutcomeForCategory(grade, q.category || "") !== outcomeFilter);
  } else {
    primaryPool = [...fullBank];
  }

  const shuffle = (array: any[]) => {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  };

  const shuffledPrimary = shuffle(primaryPool);
  const shuffledFallback = shuffle(fallbackPool);

  const finalSelection = [
    ...shuffledPrimary.slice(0, count),
    ...shuffledFallback.slice(0, Math.max(0, count - shuffledPrimary.length))
  ];

  return finalSelection.map((q, index) => ({
    ...q,
    id: index + 1
  }));
};

export const getEnrichingFacts = (grade: Grade, count: number = 6): ScienceFact[] => {
  const facts: Record<Grade, ScienceFact[]> = {
    [Grade.PRI_3]: [
      { title: "الأرض الزرقاء", description: "يسمى كوكب الأرض بالكوكب الأزرق لأن الماء يغطي أكثر من 70% من سطحه.", category: "earth" }
    ],
    [Grade.PRI_6]: [
      { title: "المصنع الأخضر", description: "البلاستيدات الخضراء في أوراق الشجر هي التي تصنع الغذاء لكل الكائنات الحية تقريباً عبر البناء الضوئي!", category: "biology" }
    ],
    [Grade.INT_3]: [
      { title: "الـ DNA المذهل", description: "لو قمت بفك شريط الـ DNA الموجود في خلية واحدة، سيصل طوله إلى مترين تقريباً!", category: "biology" },
      { title: "حلقة النار", description: "منطقة حول المحيط الهادئ تسمى حلقة النار لأنها تحتوي على 75% من براكين العالم النشطة.", category: "earth" }
    ]
  };

  const pool = facts[grade] || facts[Grade.PRI_3];
  return [...pool].sort(() => 0.5 - Math.random()).slice(0, count);
};
